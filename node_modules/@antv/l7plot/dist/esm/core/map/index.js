import { __rest } from "tslib";
import EventEmitter from '@antv/event-emitter';
import { GaodeMap, GaodeMapV1, GaodeMapV2, Map as L7Map, Mapbox, Scale, Scene, Zoom } from '@antv/l7';
import { isBoolean, isEqual, isObject, isUndefined } from '@antv/util';
import { Legend } from '../../component/legend';
import { Tooltip } from '../../component/tooltip';
import { getTheme } from '../../theme';
import { createTheme } from '../../theme/util';
import { BaseMapType } from '../../types';
import { deepAssign } from '../../utils';
import { LayerGroup } from '../layer/layer-group';
import { LayerEventList, MapEventList, SceneEventList } from './constants';
import { FONT_FACE_CACHE, ICON_FONT_CACHE, IMAGES_CACHE } from './register';
const DEFAULT_OPTIONS = {
    map: { type: BaseMapType.Amap },
    logo: true,
};
export class Map extends EventEmitter {
    constructor(options) {
        super();
        /**
         * 是否初始化成功
         */
        this.inited = false;
        /**
         * 是否场景加载完成
         */
        this.sceneLoaded = false;
        /**
         * 是否所有图层加载完成
         */
        this.layersLoaded = false;
        /**
         * 是否场景与所有图层加载完成
         */
        this.loaded = false;
        /**
         * 图层组
         */
        this.layerGroup = new LayerGroup();
        this.options = deepAssign({}, this.getDefaultOptions(), options);
        this.lastOptions = this.options;
    }
    /**
     * 获取默认配置
     */
    getDefaultOptions() {
        return Map.DefaultOptions;
    }
    /**
     * 创建 DOM 容器
     */
    createContainer(container) {
        const { width, height } = this.options;
        const dom = typeof container === 'string' ? document.getElementById(container) : container;
        dom.style.position || (dom.style.position = 'relative');
        if (width) {
            dom.style.width || (dom.style.width = `${width}px`);
        }
        if (height) {
            dom.style.height || (dom.style.height = `${height}px`);
        }
        return dom;
    }
    /**
     * 注册主题
     */
    createTheme() {
        const theme = isObject(this.options.theme)
            ? deepAssign({}, getTheme('default'), createTheme(this.options.theme))
            : getTheme(this.options.theme);
        return theme;
    }
    /**
     * 创建 map 容器
     */
    createMap() {
        // eslint-disable-next-line @typescript-eslint/no-non-null-assertion
        const mapConfig = this.options.map ? this.options.map : DEFAULT_OPTIONS.map;
        const { type } = mapConfig, config = __rest(mapConfig, ["type"]);
        const options = Object.assign({ style: this.theme['mapStyle'] }, config);
        return type === BaseMapType.Amap
            ? new GaodeMap(options)
            : type === BaseMapType.AmapV1
                ? new GaodeMapV1(options)
                : type === BaseMapType.AmapV2
                    ? new GaodeMapV2(options)
                    : type === BaseMapType.Mapbox
                        ? new Mapbox(options)
                        : new L7Map(options);
    }
    /**
     * 创建 scene 实例
     */
    createScene() {
        const { logo, antialias, preserveDrawingBuffer } = this.options;
        const logoConfig = isBoolean(logo)
            ? { logoVisible: logo }
            : { logoVisible: logo === null || logo === void 0 ? void 0 : logo.visible, logoPosition: logo === null || logo === void 0 ? void 0 : logo.position };
        const sceneConfig = Object.assign({
            // animate,
            // fitBoundsOptions,
            // pickBufferScale,
            // enableMultiPassRenderer,
            // passes,
            antialias,
            preserveDrawingBuffer,
        }, logoConfig);
        const map = this.createMap();
        const scene = new Scene(Object.assign({ id: this.container, map: map }, sceneConfig));
        return scene;
    }
    /**
     * 注册静态资源
     */
    registerResources() {
        if (IMAGES_CACHE.size) {
            IMAGES_CACHE.forEach((img, id) => {
                !this.scene.hasImage(id) && this.scene.addImage(id, img);
            });
        }
        if (FONT_FACE_CACHE.size) {
            FONT_FACE_CACHE.forEach((fontPath, fontFamily) => {
                this.scene.addFontFace(fontFamily, fontPath);
            });
        }
        if (ICON_FONT_CACHE.size) {
            ICON_FONT_CACHE.forEach((name, fontUnicode) => {
                this.scene.addIconFont(fontUnicode, name);
            });
        }
    }
    /**
     * 更新: 更新配置且重新渲染
     */
    update(options) {
        this.updateOption(options);
        if (options.map && !isEqual(this.lastOptions.map, this.options.map)) {
            this.updateMap(options.map);
        }
        this.render();
        this.emit('update');
    }
    /**
     * 更新: 更新配置
     */
    updateOption(options) {
        this.lastOptions = this.options;
        this.options = deepAssign({}, this.options, options);
    }
    /**
     * 更新: 地图底图配置
     */
    updateMap(updateMapConfig) {
        var _a;
        if (!this.scene)
            return;
        const { style, center, zoom, rotation, pitch } = updateMapConfig;
        if (!isUndefined(pitch)) {
            this.scene.setPitch(pitch);
        }
        if (!isUndefined(rotation)) {
            this.scene.setRotation(rotation);
        }
        if (style && style !== ((_a = this.lastOptions.map) === null || _a === void 0 ? void 0 : _a.style)) {
            this.scene.setMapStyle(style);
        }
        if (zoom && center) {
            this.scene.setZoomAndCenter(zoom, center);
        }
    }
    /**
     * 修改容器大小
     */
    changeSize(width, height) {
        if (this.options.width === width && this.options.height === height)
            return;
        this.container.style.width = `${width}px`;
        this.container.style.height = `${height}px`;
        this.options = Object.assign(this.options, { width, height });
    }
    /**
     * 事件代理: 绑定事件
     */
    on(name, callback, once) {
        this.proxyEventHander('on', name, callback, once);
        return this;
    }
    /**
     * 事件代理: 绑定一次事件
     */
    once(name, callback) {
        this.proxyEventHander('once', name, callback);
        return this;
    }
    /**
     * 事件代理: 解绑事件
     */
    off(name, callback) {
        this.proxyEventHander('off', name, callback);
        return this;
    }
    /**
     * 事件代理: 事件处理
     */
    proxyEventHander(type, name, callback, once) {
        const sceneEvent = SceneEventList.find((event) => event.adaptation === name);
        if (sceneEvent) {
            this.scene[type](sceneEvent.original, callback);
        }
        else if (MapEventList.indexOf(name) !== -1) {
            this.scene[type](name, callback);
        }
        else if (name.includes('Layer:')) {
            const [module, eventName] = name.split(':');
            const hasEventEmitter = this[module] && this[module][type];
            if (hasEventEmitter && LayerEventList.indexOf(eventName) !== -1) {
                this[module][type](eventName, callback);
            }
            else {
                throw new Error(`No event name "${name}"`);
            }
        }
        else {
            super[type](name, callback, once);
        }
    }
    /**
     * 获取 scene 实例
     */
    getScene() {
        return this.scene;
    }
    /**
     * 获取 map 实例
     */
    getMap() {
        var _a, _b, _c, _d;
        if (((_a = this.options.map) === null || _a === void 0 ? void 0 : _a.type) === BaseMapType.Amap) {
            return this.scene.map;
        }
        else if (((_b = this.options.map) === null || _b === void 0 ? void 0 : _b.type) === BaseMapType.AmapV2) {
            return this.scene.map;
        }
        else if (((_c = this.options.map) === null || _c === void 0 ? void 0 : _c.type) === BaseMapType.Mapbox) {
            return this.scene.map;
        }
        else if (((_d = this.options.map) === null || _d === void 0 ? void 0 : _d.type) === BaseMapType.Map) {
            return this.scene.map;
        }
        else {
            return this.scene.map;
        }
    }
    /**
     * 添加图层
     */
    addLayer(layer) {
        this.layerGroup.addLayer(layer);
    }
    /**
     * 获取所有图层
     *  @deprecate
     */
    getLayes() {
        console.warn('Replace to use getLayers()');
        return this.getLayers();
    }
    /**
     * 获取所有图层
     */
    getLayers() {
        return this.layerGroup.getLayers();
    }
    /**
     * 根据图层名称获取图层
     */
    getLayerByName(name) {
        return this.layerGroup.getLayerByName(name);
    }
    /**
     * 移除图层
     */
    removeLayer(layer) {
        return this.layerGroup.removeLayer(layer);
    }
    /**
     * 移除内置所有的图层
     */
    removeAllLayer() {
        this.layerGroup.removeAllLayer();
    }
    /**
     * 地图放大一级
     */
    zoomIn() {
        this.scene.zoomIn();
    }
    /**
     * 地图缩小一级
     */
    zoomOut() {
        this.scene.zoomOut();
    }
    /**
     * 设置地图倾角
     */
    setPitch(pitch) {
        this.scene.setPitch(pitch);
    }
    /**
     * 设置地图缩放范围
     */
    fitBounds(bound) {
        this.scene.fitBounds(bound);
    }
    /**
     * 设置地图状态
     * 可用来关闭地图的一些交互操作
     */
    setMapStatus(status) {
        this.scene.setMapStatus(status);
    }
    /**
     * 设置场景的背景色
     */
    setBgColor(color) {
        this.scene.setBgColor(color);
    }
    /**
     * 初始化组件
     */
    initComponents() {
        this.initControls();
        this.initTooltip();
    }
    /**
     * 更新化组件
     */
    updateComponents() {
        this.updateControls();
        this.initTooltip();
    }
    /**
     * 初始化控件
     */
    initControls() {
        const { zoom, scale, layerMenu, legend } = this.options;
        scale && this.addScaleControl(scale);
        zoom && this.addZoomControl(zoom);
        layerMenu && this.addLayerMenuControl(layerMenu);
        if (legend) {
            this.addLegendControl(legend);
            this.emit('add-legend');
        }
    }
    /**
     * 更新控件
     */
    updateControls() {
        const { zoom, scale, layerMenu, legend } = this.options;
        if (!isEqual(this.lastOptions.zoom, zoom)) {
            zoom ? this.updateZoomControl(zoom) : this.removeZoomControl();
        }
        if (!isEqual(this.lastOptions.scale, scale)) {
            scale ? this.updateScaleControl(scale) : this.removeScaleControl();
        }
        if (!isEqual(this.lastOptions.layerMenu, layerMenu)) {
            layerMenu ? this.updateLayerMenuControl(layerMenu) : this.removeLayerMenuControl();
        }
        if (!isEqual(this.lastOptions.legend, legend)) {
            legend ? this.updateLegendControl(legend) : this.removeLegendControl();
        }
    }
    /**
     * 添加 zoom 控件
     */
    addZoomControl(options) {
        if (this.zoomControl) {
            return;
        }
        this.zoomControl = new Zoom(options);
        this.scene.addControl(this.zoomControl);
    }
    /**
     * 更新 zoom 控件
     */
    updateZoomControl(options) {
        if (!this.zoomControl) {
            this.addZoomControl(options);
            return;
        }
        this.removeZoomControl();
        this.addZoomControl(options);
    }
    /**
     * 移除 zoom 控件
     */
    removeZoomControl() {
        if (this.zoomControl) {
            this.zoomControl.remove();
            this.zoomControl = undefined;
        }
    }
    /**
     * 添加 scale 控件
     */
    addScaleControl(options) {
        if (this.scaleControl) {
            return;
        }
        this.scaleControl = new Scale(options);
        this.scene.addControl(this.scaleControl);
    }
    /**
     * 更新 scale 控件
     */
    updateScaleControl(options) {
        if (!this.scaleControl) {
            this.addScaleControl(options);
            return;
        }
        this.removeScaleControl();
        this.addScaleControl(options);
    }
    /**
     * 移除 scale 控件
     */
    removeScaleControl() {
        if (this.scaleControl) {
            this.scaleControl.remove();
            this.scaleControl = undefined;
        }
    }
    /**
     * 添加 layerMenu 控件
     */
    addLayerMenuControl(options) {
        // if (this.layerMenuControl) {
        //   return;
        // }
        const baseLayers = {};
        const overlayers = {};
        this.layerGroup.getLayers().forEach(({ name, layer }) => {
            overlayers[name] = layer;
        });
        // this.layerMenuControl = new Layers(Object.assign({}, options, { baseLayers, overlayers }));
        // this.scene.addControl(this.layerMenuControl);
    }
    /**
     * 更新 layerMenu 控件
     */
    updateLayerMenuControl(options) {
        // if (!this.layerMenuControl) {
        //   this.addLayerMenuControl(options);
        //   return;
        // }
        this.removeLayerMenuControl();
        this.addLayerMenuControl(options);
    }
    /**
     * 移除 layerMenu 控件
     */
    removeLayerMenuControl() {
        // if (this.layerMenuControl) {
        //   this.layerMenuControl.remove();
        //   this.layerMenuControl = undefined;
        // }
    }
    /**
     * 获取 legend 配置项
     * 由各图各自实现，不同的图 legend 可能不同
     */
    getLegendOptions() {
        return {};
    }
    /**
     * 添加 legend 控件
     */
    addLegendControl(options) {
        if (this.legendControl) {
            return;
        }
        const legendTheme = this.theme['components'].legend;
        const legendOptions = deepAssign({}, this.getLegendOptions(), options);
        const { type, position } = legendOptions, rest = __rest(legendOptions, ["type", "position"]);
        const items = [];
        if (type === 'category') {
            const options = deepAssign({}, { domStyles: legendTheme.category.domStyles }, rest);
            items.push({ type, options });
        }
        else if (type === 'continue') {
            const options = deepAssign({}, { domStyles: legendTheme.continue.domStyles }, rest);
            items.push({ type, options });
        }
        if (items.length) {
            this.legendControl = new Legend({ position, items });
            this.scene.addControl(this.legendControl);
        }
    }
    /**
     * 更新 legend 控件
     */
    updateLegendControl(options) {
        if (!this.legendControl) {
            this.addLegendControl(options);
            return;
        }
        this.removeLegendControl();
        this.addLegendControl(options);
    }
    /**
     * 移除 legend 控件
     */
    removeLegendControl() {
        if (this.legendControl) {
            this.legendControl.remove();
            this.legendControl = undefined;
        }
    }
    /**
     * 初始化 tooltip
     */
    initTooltip() {
        if (this.tooltip) {
            this.tooltip.destroy();
        }
        const { tooltip } = this.options;
        if (tooltip) {
            const options = deepAssign({}, { domStyles: this.theme['components'].tooltip.domStyles }, tooltip);
            const interactionLayers = this.layerGroup.getInteractionLayers();
            this.tooltip = new Tooltip(this.scene, interactionLayers, options);
            this.tooltip.on('*', (event) => this.emit(event.type, event));
        }
    }
    /**
     * 导出地图图片
     */
    exportPng(type) {
        return this.scene.exportPng(type);
    }
    /**
     * 销毁
     */
    destroy() {
        var _a;
        // TODO: 清空已经绑定其他的事件
        super.off('*');
        this.removeScaleControl();
        this.removeZoomControl();
        this.removeLayerMenuControl();
        this.removeLegendControl();
        (_a = this.tooltip) === null || _a === void 0 ? void 0 : _a.destroy();
        this.scene.destroy();
    }
}
/**
 * 默认的 options 配置项
 */
Map.DefaultOptions = DEFAULT_OPTIONS;
//# sourceMappingURL=index.js.map